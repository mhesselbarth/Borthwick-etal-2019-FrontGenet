---
output: html_document
editor_options: 
  chunk_output_type: console
---

## Analysis steps Max

```{r setup, include = FALSE}
library(knitr)
library(landscapemetrics)
library(raster)
```

* Reclassify NLCD data of Indiana according to Table 1

```{r table-classification, echo = FALSE}
id <- c(11, 21, 22, 23, 24, 31, 41, 42, 43, 52, 71, 81, 82, 90, 95, 127)

nlcd <- c("water", "urban", "residential (lo)", "residential (hi)",
          "commercial", "rock", "forest (d)", "forest (e)", "forest (m)",
          "shrub", "grass", "pasture", "crops", "wetlands (w)", 
          "wetlands (h)", "NA")
  
nlcd_reclassified <- data.frame(id, nlcd)
  
#forest habitat
nlcd_reclassified$habitat[nlcd_reclassified$id %in% c(41, 42, 43)] <- "suitable"
  
# complementary habitat
nlcd_reclassified$habitat[nlcd_reclassified$id %in% c(52, 71, 81)] <- "complementary habitat"

# non-habitat
nlcd_reclassified$habitat[!nlcd_reclassified$habitat %in% c("suitable", "complementary habitat")] <- "non habitat"

knitr::kable(nlcd_reclassified, 
             caption = "Table 1: Reclassification of NLCD data",
             col.names = c("ID", "Name", "Re-classification"))

```

* Croppings of ellipsoidal landscapes between sampling sites
  * Landscapes including most likely beetle dispersal routes between sites
  * Resulting in 136 landscapes
  * Using correlated random walk as described in:
    * Koh, I., Rowe, H. I., & Holland, J. D. (2013). Graph and circuit theory connectivity models of conservation biological control agents. Ecological applications, 23(7), 1554-1573.
  * And used in:
      * Abdel Moniem, H. E. M., & Holland, J. D. (2013). Habitat connectivity for pollinator beetles using surface metrics. Landscape Ecology, 28(7), 1251–1267.
      * Abdel Moniem, H. E. M., Schemerhorn, B. J., DeWoody, J. A., & Holland, J. D. (2016). Landscape genetics of a pollinator longhorn beetle [Typocerus v. velutinus (Olivier)] on a continuous habitat surface. Molecular Ecologycology, 25(20), 5015–5028.

* Calculating landscape metrics for landscapes
  * Calculated metrics on class- and landscape-level listed in Table 2 and Table 3
  
```{r landscape-metrics, echo = FALSE}
class <- c("lsm_c_ai", 
           "lsm_c_area_mn", 
           "lsm_c_ca", 
           "lsm_c_cai_mn", 
           "lsm_c_clumpy", 
           "lsm_c_core_mn", 
           "lsm_c_cpland", 
           "lsm_c_division", 
           "lsm_c_iji", 
           "lsm_c_lpi", 
           "lsm_c_lsi",
           "lsm_c_mesh", 
           "lsm_c_np", 
           "lsm_c_pd", 
           "lsm_c_pladj", 
           "lsm_c_pland", 
           "lsm_c_split", 
           "lsm_c_te")

landscape <- c("lsm_l_ai", 
               "lsm_l_area_mn", 
               "lsm_l_cai_mn", 
               "lsm_l_condent", 
               "lsm_l_contag", 
               "lsm_l_core_mn", 
               "lsm_l_division", 
               "lsm_l_ed", 
               "lsm_l_ent", 
               "lsm_l_iji", 
               "lsm_l_joinent",
               "lsm_l_lpi", 
               "lsm_l_lsi", 
               "lsm_l_mesh", 
               "lsm_l_mutinf", 
               "lsm_l_np", 
               "lsm_l_pd", 
               "lsm_l_pladj", 
               "lsm_l_pr", 
               "lsm_l_prd", 
               "lsm_l_rpr", 
               "lsm_l_shdi", 
               "lsm_l_shei",
               "lsm_l_sidi,",
               "lsm_l_siei",
               "lsm_l_split", 
               "lsm_l_ta", 
               "lsm_l_te")

class_level <- landscapemetrics::list_lsm(what = class)

landscape_level <- landscapemetrics::list_lsm(what = landscape)

knitr::kable(class_level[, c(1, 2, 3, 4)], 
             caption = "Table 2: Calculated class-level metrics")

knitr::kable(landscape_level[, c(1, 2, 3, 4)], 
             caption = "Table 3: Calculated landscape-level metrics")
```

* Calculate correlation between metrics
  * Using Pearson correlation
  * Mantel correlation between RST and patch metrics using `ecodist::mante(RST ~ value)`
    * Using landscape-level metrics
    * Using class-level metrics for "habitat" class

* Running model on data
  * Removing "patch richness" (pr) and "relative patch richness" (rpr) because pr=3 and rpr=100% for all landscapes
  * Subsequently removing metric with the highest variance inflation factor using `vif::usdm()` until all metrics are below VIF < 10 (Table 4)
  * Rescaling all metrics
  * Fitting a mixed model with a random effect on the site using `lme4::lFormula(RST ~ Sa_scaled + S10z_scaled + Ssk + Sku + Sdr_scaled + Sbi + Std_scaled + Stdi + Sfd + Srwi + (1|site_1)`
  * Optimize model using ` lme4::optimizeLmer()`
  * Trying to dredge model/model selection
  
```{r remaining-metrics, echo = FALSE}
remaining_metrics <- data.frame(Metrics = c("pd", 
                                            "iji",    
                                            "prd",
                                            "core_mn",
                                            "cai_mn",
                                            "split",
                                            "mesh"), 
                                VIF = c(7.172478,
                                        6.691856,
                                        6.025912,
                                        5.626735,
                                        4.197641,
                                        2.245560,
                                        1.891422))

knitr::kable(remaining_metrics, 
             caption = "Table 4: Remaining landscape-level metrics with a VIF < 10")
```
  